<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∑É‡∑í‡∂¥‡∑ä‡∂∏‡∑í‡∂´‡∑í-‡∂ú‡∑î‡∂ª‡∑î‡∂∑‡∑Ä‡∂≠‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f9fafb;
            color: #1f2937;
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .hidden {
            display: none !important;
        }

        /* Login Screen */
        .login-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #3b82f6, #9333ea, #ec4899);
            padding: 1rem;
        }

        .login-box {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2rem;
            width: 100%;
            max-width: 28rem;
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-icon {
            background: linear-gradient(135deg, #2563eb, #9333ea);
            width: 5rem;
            height: 5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
        }

        .login-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
        }

        .login-subtitle {
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #9333ea;
        }

        .error-box {
            background: #fef2f2;
            border-left: 4px solid #ef4444;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin-bottom: 1.5rem;
        }

        .error-text {
            color: #b91c1c;
            font-size: 0.875rem;
        }

        .btn {
            width: 100%;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2563eb, #9333ea);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover {
            transform: scale(1.02);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background: #eff6ff;
            border-radius: 0.5rem;
            text-align: center;
        }

        .info-text {
            font-size: 0.75rem;
            color: #1e40af;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #2563eb, #9333ea);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.875rem;
            font-weight: bold;
        }

        .header-subtitle {
            color: #bfdbfe;
            margin-top: 0.25rem;
        }

        .btn-logout {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: white;
            color: #2563eb;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-logout:hover {
            background: #eff6ff;
        }

        /* Controls */
        .controls-box {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .controls-content {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .select-group {
            flex: 1;
            min-width: 200px;
        }

        .select-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
        }

        .select-input:focus {
            outline: none;
            border-color: #9333ea;
        }

        .btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .btn-action {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
        }

        .btn-green {
            background: #16a34a;
            color: white;
        }

        .btn-green:hover {
            background: #15803d;
        }

        .btn-blue {
            background: #2563eb;
            color: white;
        }

        .btn-blue:hover {
            background: #1d4ed8;
        }

        .btn-whatsapp {
            background: #22c55e;
            color: white;
        }

        .btn-orange {
            background: #f97316;
            color: white;
        }

        .btn-orange:hover {
            background: #ea580c;
        }

        /* Loading */
        .loading-container {
            text-align: center;
            padding: 3rem 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #9333ea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: #6b7280;
            margin-top: 1rem;
        }

        /* Summary Cards */
        .grid {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        }

        .card {
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            color: white;
        }

        .card-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .card-green { background: linear-gradient(135deg, #10b981, #059669); }
        .card-red { background: linear-gradient(135deg, #ef4444, #dc2626); }
        .card-purple { background: linear-gradient(135deg, #a855f7, #9333ea); }
        .card-yellow { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .card-orange { background: linear-gradient(135deg, #f97316, #ea580c); }

        .card-label {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .card-value {
            font-size: 2.25rem;
            font-weight: bold;
            margin-top: 0.25rem;
        }

        .card-icon {
            opacity: 0.7;
        }

        /* Charts */
        .chart-box {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Table */
        .table-box {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #2563eb, #9333ea);
        }

        .table-header-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: bold;
            color: #374151;
            background: #f3f4f6;
        }

        th.text-right { text-align: right; }
        th.text-center { text-align: center; }

        td {
            padding: 1rem 1.5rem;
            font-size: 0.875rem;
            border-top: 1px solid #e5e7eb;
        }

        td.text-right { text-align: right; }
        td.text-center { text-align: center; }

        tr:nth-child(even) {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-flex;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 9999px;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .text-green { color: #059669; font-weight: 600; }
        .text-red { color: #dc2626; font-weight: 600; }
        .text-orange { color: #ea580c; }
        .text-blue { color: #2563eb; }
        .text-gray { color: #6b7280; }
        .font-bold { font-weight: 600; }

        /* No Data */
        .no-data-box {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            padding: 3rem;
            text-align: center;
        }

        .no-data-icon {
            color: #9ca3af;
            margin: 0 auto 1rem;
        }

        .no-data-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .no-data-text {
            color: #6b7280;
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            body { background: white; }
            .print-show { display: block !important; }
            .container { padding: 0; }
        }

        .print-show { display: none; }
        
        .print-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .print-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #1f2937;
        }

        .print-subtitle {
            font-size: 1.25rem;
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .print-footer {
            margin-top: 2rem;
            text-align: center;
            color: #6b7280;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .controls-content {
                flex-direction: column;
            }

            .btn-group {
                width: 100%;
            }

            .btn-action {
                flex: 1;
                justify-content: center;
            }

            .card-value {
                font-size: 1.875rem;
            }

            th, td {
                padding: 0.75rem;
                font-size: 0.75rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-wrapper">
        <div class="login-box">
            <div class="login-header">
                <div class="login-icon">
                    <svg width="40" height="40" fill="none" stroke="white" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                    </svg>
                </div>
                <h1 class="login-title">‡∑É‡∑í‡∂¥‡∑ä‡∂∏‡∑í‡∂´‡∑í-‡∂ú‡∑î‡∂ª‡∑î‡∂∑‡∑Ä‡∂≠‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h1>
                <p class="login-subtitle">‡∂î‡∂∂‡∂ú‡∑ö ‡∂ú‡∑í‡∂´‡∑î‡∂∏‡∂ß ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</p>
            </div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label">‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å ‡∂ö‡∑ö‡∂≠‡∂∫</label>
                    <input type="text" id="accessCode" class="form-input" placeholder="‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å ‡∂ö‡∑ö‡∂≠‡∂∫ ‡∂á‡∂≠‡∑î‡∑Ö‡∂≠‡∑ä ‡∂ö‡∂ª‡∂±‡∑ä‡∂±" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫</label>
                    <input type="password" id="password" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                
                <div id="loginError" class="error-box hidden">
                    <p class="error-text"></p>
                </div>
                
                <button type="submit" id="loginBtn" class="btn btn-primary">‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±</button>
            </form>
            
            <div class="info-box">
                <p class="info-text">üîí ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑î‡∂∏‡∂ö‡∑ä - Supabase Database Authentication</p>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Header -->
        <div class="header no-print">
            <div class="header-content">
                <div>
                    <h1 class="header-title">‡∑É‡∑í‡∂¥‡∑ä‡∂∏‡∑í‡∂´‡∑í ‡∂Ö‡∂∞‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∂± ‡∂Ü‡∂∫‡∂≠‡∂±‡∂∫-‡∂ú‡∑î‡∂ª‡∑î‡∂∑‡∑Ä‡∂≠‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h1>
                    <p class="header-subtitle" id="welcomeText">‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä</p>
                </div>
                <button onclick="logout()" class="btn-logout">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                    ‡∂¥‡∑í‡∂ß‡∑Ä‡∑ì‡∂∏
                </button>
            </div>
        </div>

        <!-- Controls -->
        <div class="container no-print">
            <div class="controls-box">
                <div class="controls-content">
                    <div class="select-group">
                        <label class="form-label">üìÖ ‡∂∏‡∑è‡∑É‡∂∫ ‡∂≠‡∑ù‡∂ª‡∂±‡∑ä‡∂±</label>
                        <select id="monthSelect" class="select-input" onchange="fetchReportData()">
                            <option value="01">‡∂¢‡∂±‡∑Ä‡∑è‡∂ª‡∑í</option>
                            <option value="02">‡∂¥‡∑ô‡∂∂‡∂ª‡∑Ä‡∑è‡∂ª‡∑í</option>
                            <option value="03">‡∂∏‡∑è‡∂ª‡∑ä‡∂≠‡∑î</option>
                            <option value="04">‡∂Ö‡∂¥‡∑ä‚Äç‡∂ª‡∑ö‡∂Ω‡∑ä</option>
                            <option value="05">‡∂∏‡∑ê‡∂∫‡∑í</option>
                            <option value="06">‡∂¢‡∑ñ‡∂±‡∑í</option>
                            <option value="07">‡∂¢‡∑ñ‡∂Ω‡∑í</option>
                            <option value="08">‡∂Ö‡∂ú‡∑ù‡∑É‡∑ä‡∂≠‡∑î</option>
                            <option value="09">‡∑É‡∑ê‡∂¥‡∑ä‡∂≠‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä</option>
                            <option value="10">‡∂î‡∂ö‡∑ä‡∂≠‡∑ù‡∂∂‡∂ª‡∑ä</option>
                            <option value="11">‡∂±‡∑ú‡∑Ä‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä</option>
                            <option value="12">‡∂Ø‡∑ô‡∑É‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä</option>
                        </select>
                    </div>
                    
                    <div class="btn-group">
                        <button onclick="toggleStudentView()" id="toggleViewBtn" class="btn-action btn-blue">
                            üë• ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä
                        </button>
                        <button onclick="downloadPDF()" class="btn-action btn-green">üì• PDF</button>
                        <button onclick="copyReport()" class="btn-action btn-blue">üìã ‡∂¥‡∑í‡∂ß‡∂¥‡∂≠‡∑ä</button>
                        <button onclick="shareWhatsApp()" class="btn-action btn-whatsapp">üí¨ WhatsApp</button>
                    </div>
                </div>
            </div>

            <div id="loadingSpinner" class="loading-container hidden">
                <div class="spinner"></div>
                <p class="loading-text">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑í‡∂∏‡∑í‡∂±‡∑ä...</p>
            </div>
        </div>

        <!-- Report Content -->
        <div id="reportContent" class="container hidden">
            <!-- Print Header -->
            <div class="print-header print-show">
                <h1 class="print-title">‡∂ú‡∑î‡∂ª‡∑î ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</h1>
                <p class="print-subtitle" id="printHeader"></p>
            </div>

            <!-- Summary Cards -->
            <div id="summaryCards" class="grid grid-3"></div>

            <!-- Charts -->
            <div class="grid grid-2">
                <div class="chart-box">
                    <h3 class="chart-title">‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä‡∂ú‡∑ö ‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂≠‡∂≠‡∑ä‡∑Ä‡∂∫</h3>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>

                <div class="chart-box">
                    <h3 class="chart-title">‡∂ú‡∑ô‡∑Ä‡∑ì‡∂∏‡∑ä ‡∂≠‡∂≠‡∑ä‡∑Ä ‡∑Ä‡∑ä‚Äç‡∂∫‡∑è‡∂¥‡∑ä‡∂≠‡∑í‡∂∫</h3>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Detailed Table -->
            <div class="table-box">
                <div class="table-header">
                    <h3 class="table-header-title" id="tableHeader">‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä</h3>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>‡∂Ö‡∂Ç‡∂ö‡∂∫</th>
                                <th>‡∑É‡∑í‡∑É‡∑î ‡∂±‡∂∏</th>
                                <th class="text-right">‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä</th>
                                <th class="text-right">‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω</th>
                                <th class="text-right">‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω</th>
                                <th class="text-center">‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑è‡∑É</th>
                                <th class="text-center">‡∑Ñ‡∑í‡∂ü ‡∂Ø‡∑í‡∂±</th>
                                <th class="text-center">‡∂¥‡∑ê‡∂∏‡∑í‡∂´‡∑ì‡∂∏‡∑ä</th>
                                <th class="text-center">‡∂≠‡∂≠‡∑ä‡∑Ä‡∂∫</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="print-footer print-show">
                <p id="printFooter"></p>
                <p style="font-size: 0.75rem; margin-top: 0.5rem;">üîí Supabase ‡∂Ü‡∂ª‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂¥‡∂Ø‡∑ä‡∂∞‡∂≠‡∑í‡∂∫</p>
            </div>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="container hidden">
            <div class="no-data-box">
                <svg class="no-data-icon" width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <h3 class="no-data-title">‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫</h3>
                <p class="no-data-text" id="noDataText"></p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uqgzlaxsnknheoerbfus.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZ3psYXhzbmtuaGVvZXJiZnVzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4MDQzMTEsImV4cCI6MjA2MDM4MDMxMX0.O5dNUizqZ5kfwTs0mHLEorqOAqjZFjWakp2Q484MKEk';
        
        const TEACHER_MAPPING = {
            'jaya': '‡∂∏‡∑Ñ‡∑è‡∂†‡∑è‡∂ª‡∑ä‡∂∫ ‡∂†‡∂ª‡∑í‡∂≠‡∑ä ‡∂¢‡∂∫‡∂≠‡∑í‡∂Ω‡∂ö',
            'gee': '‡∂∞‡∂∏‡∑ä‡∂∏‡∑í‡∂ö ‡∂ú‡∑ì‡∂ö‡∑í‡∂∫‡∂±‡∂ú‡∑ö',
            'pin': '‡∂â‡∂ª‡∑ö‡∑Ç‡∑è ‡∂¥‡∑í‡∂±‡∑ä‡∂≠‡∑î',
            'alm': '‡∑É‡∑î‡∂¥‡∑ô‡∂∏‡∑ä ‡∂Ö‡∂Ω‡∑ä‡∂∏‡∑ö‡∂Ø‡∑è',
            'har': '‡∑Ñ‡∂ª‡∑ä‡∑Ç‡∂´ ‡∂Ω‡∑í‡∂∫‡∂±‡∂Ü‡∂ª‡∂†‡∑ä‡∂†‡∑í',
            'pra': '‡∂¥‡∑ä‚Äç‡∂ª‡∑É‡∑è‡∂∞‡∑í ‡∂¢‡∂∫‡∂≠‡∑í‡∂Ω‡∂ö',
            'ami': '‡∂Ö‡∂∏‡∑í‡∂Ω ‡∂ã‡∂©‡∑Ä‡∂≠‡∑ä‡∂≠',
            'nis': '‡∂±‡∑í‡∑Ç‡∑è ‡∂â‡∑Ñ‡∑Ö‡∂ú‡∂∏',
            'hal': '‡∂Ø‡∑í‡∂±‡∑ö‡∑Ç‡∑ä ‡∑Ñ‡∂Ω‡∑ä‡∂ï‡∑Ä‡∑í‡∂ß'
        };
        
        let currentTeacherName = '';
        let currentAccessCode = '';
        let reportData = [];
        let allStudentsData = [];
        let showAllStudents = false;
        let barChartInstance = null;
        let pieChartInstance = null;

        const MONTHS = {
            '01': '‡∂¢‡∂±‡∑Ä‡∑è‡∂ª‡∑í', '02': '‡∂¥‡∑ô‡∂∂‡∂ª‡∑Ä‡∑è‡∂ª‡∑í', '03': '‡∂∏‡∑è‡∂ª‡∑ä‡∂≠‡∑î', '04': '‡∂Ö‡∂¥‡∑ä‚Äç‡∂ª‡∑ö‡∂Ω‡∑ä',
            '05': '‡∂∏‡∑ê‡∂∫‡∑í', '06': '‡∂¢‡∑ñ‡∂±‡∑í', '07': '‡∂¢‡∑ñ‡∂Ω‡∑í', '08': '‡∂Ö‡∂ú‡∑ù‡∑É‡∑ä‡∂≠‡∑î',
            '09': '‡∑É‡∑ê‡∂¥‡∑ä‡∂≠‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä', '10': '‡∂î‡∂ö‡∑ä‡∂≠‡∑ù‡∂∂‡∂ª‡∑ä', '11': '‡∂±‡∑ú‡∑Ä‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä', '12': '‡∂Ø‡∑ô‡∑É‡∑ê‡∂∏‡∑ä‡∂∂‡∂ª‡∑ä'
        };

        document.getElementById('monthSelect').value = String(new Date().getMonth() + 1).padStart(2, '0');

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const accessCode = document.getElementById('accessCode').value.toLowerCase().trim();
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;"><div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div>‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂∏‡∑í‡∂±‡∑ä...</div>';
            errorDiv.classList.add('hidden');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/credentials?access_code=ilike.${accessCode}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                const data = await response.json();

                if (data && data.length > 0) {
                    const credential = data[0];
                    
                    if (!credential.is_active) {
                        showError('‡∂∏‡∑ô‡∂∏ ‡∂ú‡∑í‡∂´‡∑î‡∂∏ ‡∂Ö‡∂ö‡∑ä‚Äç‡∂ª‡∑í‡∂∫ ‡∂ö‡∂ª ‡∂á‡∂≠. ‡∂ö‡∂ª‡∑î‡∂´‡∑è‡∂ö‡∂ª ‡∂¥‡∂ª‡∑í‡∂¥‡∑è‡∂Ω‡∂ö‡∂∫‡∑è ‡∑É‡∂∏‡∑ä‡∂∂‡∂±‡∑ä‡∂∞ ‡∂ö‡∂ª ‡∂ú‡∂±‡∑ä‡∂±.');
                        return;
                    }

                    const inputHash = await hashPassword(password);
                    if (credential.password_hash === inputHash) {
                        try {
                            await fetch(
                                `${SUPABASE_URL}/rest/v1/credentials?id=eq.${credential.id}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'apikey': SUPABASE_KEY,
                                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                                        'Content-Type': 'application/json',
                                        'Prefer': 'return=minimal'
                                    },
                                    body: JSON.stringify({
                                        last_loging: new Date().toISOString()
                                    })
                                }
                            );
                        } catch (updateError) {
                            console.log('Last login update skipped');
                        }

                        currentAccessCode = accessCode;
                        currentTeacherName = TEACHER_MAPPING[accessCode];
                        
                        if (!currentTeacherName) {
                            showError('‡∂∏‡∑ô‡∂∏ access code ‡∂ë‡∂ö ‡∑É‡∂≥‡∑Ñ‡∑è ‡∂ú‡∑î‡∂ª‡∑î ‡∂±‡∂∏‡∂ö‡∑ä ‡∑É‡∂ö‡∑É‡∑è ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠.');
                            return;
                        }
                        
                        document.getElementById('welcomeText').textContent = `‡∂Ü‡∂∫‡∑î‡∂∂‡∑ù‡∑Ä‡∂±‡∑ä, ${currentTeacherName}`;
                        document.getElementById('loginScreen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        fetchReportData();
                    } else {
                        showError('‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂∏‡∑î‡∂ª‡∂¥‡∂Ø‡∂∫‡∂ö‡∑í');
                    }
                } else {
                    showError('‡∑Ä‡∑ê‡∂ª‡∂Ø‡∑í ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å ‡∂ö‡∑ö‡∂≠‡∂∫‡∂ö‡∑í');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ì‡∂∏‡∑ö ‡∂Ø‡∑ù‡∑Ç‡∂∫‡∂ö‡∑ä ‡∂á‡∂≠‡∑í‡∑Ä‡∑í‡∂∫. ‡∂±‡∑ê‡∑Ä‡∂≠ ‡∂ã‡∂≠‡∑ä‡∑É‡∑è‡∑Ñ ‡∂ö‡∂ª‡∂±‡∑ä‡∂±.');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = '‡∂¥‡∑í‡∑Ä‡∑í‡∑É‡∑ô‡∂±‡∑ä‡∂±';
            }
        });

        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.querySelector('p').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function logout() {
            currentTeacherName = '';
            currentAccessCode = '';
            reportData = [];
            allStudentsData = [];
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('accessCode').value = '';
            document.getElementById('password').value = '';
        }

        async function fetchReportData() {
            const loadingSpinner = document.getElementById('loadingSpinner');
            const reportContent = document.getElementById('reportContent');
            const noDataMessage = document.getElementById('noDataMessage');

            loadingSpinner.classList.remove('hidden');
            reportContent.classList.add('hidden');
            noDataMessage.classList.add('hidden');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/sipminireport?select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const allData = await response.json();
                const teacherRecords = [];
                
                if (allData && Array.isArray(allData)) {
                    allData.forEach(record => {
                        if (record.teachername && record.teachername.includes(currentTeacherName)) {
                            teacherRecords.push(record);
                        }
                    });
                }

                const selectedMonth = document.getElementById('monthSelect').value;
                const currentYear = new Date().getFullYear();

                if (teacherRecords.length === 0) {
                    showNoData();
                    return;
                }

                reportData = teacherRecords.map(student => {
                    const paymentData = student.payment || '';
                    const monthlyFee = parseFloat(student.monthly_fee) || 0;
                    const teacherShare = parseFloat(student.treport) || 0;
                    
                    const payments = [];
                    if (paymentData) {
                        const entries = paymentData.split(',').map(e => e.trim());
                        entries.forEach(entry => {
                            const match = entry.match(/(\d+)\/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\/(\d{4})-(\d+)/i);
                            if (match) {
                                const [, day, month, year, amount] = match;
                                payments.push({
                                    day: parseInt(day),
                                    month: month,
                                    year: parseInt(year),
                                    amount: parseFloat(amount)
                                });
                            }
                        });
                    }

                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    const selectedMonthName = monthNames[parseInt(selectedMonth) - 1];

                    const attendanceData = student.sreport || '';
                    const attendances = [];
                    if (attendanceData) {
                        const entries = attendanceData.split(',').map(e => e.trim());
                        entries.forEach(entry => {
                            const match = entry.match(/(\d+)\/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\/(\d{4})/i);
                            if (match) {
                                const [, day, month, year] = match;
                                attendances.push({
                                    day: parseInt(day),
                                    month: month,
                                    year: parseInt(year)
                                });
                            }
                        });
                    }

                    let totalUnpaidMonths = 0;
                    
                    const attendanceByMonth = {};
                    attendances.forEach(att => {
                        const key = `${att.month}-${att.year}`;
                        if (!attendanceByMonth[key]) {
                            attendanceByMonth[key] = [];
                        }
                        attendanceByMonth[key].push(att);
                    });

                    Object.keys(attendanceByMonth).forEach(monthKey => {
                        const [month, year] = monthKey.split('-');
                        const monthAttendances = attendanceByMonth[monthKey];
                        
                        const hasPaymentForMonth = payments.some(p => 
                            p.month === month && p.year === parseInt(year)
                        );

                        if (!hasPaymentForMonth && monthAttendances.length > 0) {
                            totalUnpaidMonths++;
                        }
                    });

                    const monthAttendance = attendances.filter(a => 
                        a.month === selectedMonthName && a.year === currentYear
                    );

                    const monthPayments = payments.filter(p => 
                        p.month === selectedMonthName && p.year === currentYear
                    );

                    let currentMonthUnpaidDays = 0;
                    if (monthAttendance.length > 0 && monthPayments.length === 0) {
                        currentMonthUnpaidDays = monthAttendance.length;
                    }

                    const outstandingAmount = totalUnpaidMonths * monthlyFee;
                    const paidAmount = monthPayments.reduce((sum, p) => sum + p.amount, 0);

                    return {
                        studentname: student.studentname || '‡∂±‡∂∏ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠',
                        monthly_fee: monthlyFee,
                        treport: teacherShare,
                        paidAmount,
                        outstandingAmount,
                        unpaidDays: currentMonthUnpaidDays,
                        monthsOutstanding: totalUnpaidMonths,
                        totalAttendance: monthAttendance.length,
                        paymentStatus: outstandingAmount === 0 ? '‡∂ú‡∑ô‡∑Ä‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä' : totalUnpaidMonths >= 3 ? '‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂ü‡∑Ä‡∑ì‡∂∏' : '‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä'
                    };
                });

                allStudentsData = reportData;
                reportData = allStudentsData.filter(s => s.outstandingAmount > 0);
                showAllStudents = false;
                updateToggleButton();

                if (allStudentsData.length > 0) {
                    renderReport();
                } else {
                    showNoData();
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                showNoData();
            }

            loadingSpinner.classList.add('hidden');
        }

        function toggleStudentView() {
            showAllStudents = !showAllStudents;
            
            if (showAllStudents) {
                reportData = allStudentsData;
            } else {
                reportData = allStudentsData.filter(s => s.outstandingAmount > 0);
            }
            
            updateToggleButton();
            renderReport();
        }

        function updateToggleButton() {
            const btn = document.getElementById('toggleViewBtn');
            if (showAllStudents) {
                btn.innerHTML = '‚ö†Ô∏è ‡∑Ñ‡∑í‡∂ü ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä';
                btn.classList.remove('btn-blue');
                btn.classList.add('btn-orange');
            } else {
                btn.innerHTML = 'üë• ‡∑É‡∑í‡∂∫‡∂Ω‡∑î ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä';
                btn.classList.remove('btn-orange');
                btn.classList.add('btn-blue');
            }
        }

        function showNoData() {
            const noDataMessage = document.getElementById('noDataMessage');
            const noDataText = document.getElementById('noDataText');
            noDataText.textContent = `‡∂∏‡∑ô‡∂∏ ‡∂∏‡∑è‡∑É‡∂∫ ‡∑É‡∂≥‡∑Ñ‡∑è ${currentTeacherName} ‡∂ß ‡∂Ö‡∂Ø‡∑è‡∑Ö ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä ‡∑Ñ‡∂∏‡∑î ‡∂±‡∑ú‡∑Ä‡∑ì‡∂∫.`;
            noDataMessage.classList.remove('hidden');
        }

        function renderReport() {
            const reportContent = document.getElementById('reportContent');
            reportContent.classList.remove('hidden');

            const selectedMonth = document.getElementById('monthSelect').value;
            const monthName = MONTHS[selectedMonth];
            const currentYear = new Date().getFullYear();

            document.getElementById('printHeader').textContent = `${currentTeacherName} - ${monthName} ${currentYear}`;
            document.getElementById('tableHeader').textContent = `‡∑É‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä - ${monthName} ${currentYear}`;
            document.getElementById('printFooter').textContent = `‡∂∏‡∑ô‡∂∏ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ${new Date().toLocaleDateString('si-LK')} ‡∂Ø‡∑í‡∂± ‡∂¢‡∂±‡∂±‡∂∫ ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì`;

            renderSummaryCards();
            renderCharts();
            renderTable();
        }

        function renderSummaryCards() {
            const summary = getSummary();
            const summaryCards = document.getElementById('summaryCards');

            summaryCards.innerHTML = `
                <div class="card card-blue">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∂∏‡∑î‡∑Ö‡∑î ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä</p>
                            <p class="card-value">${summary.totalStudents}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                    </div>
                </div>

                <div class="card card-green">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω</p>
                            <p class="card-value">‡∂ª‡∑î ${summary.totalPaid.toLocaleString()}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>

                <div class="card card-red">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω</p>
                            <p class="card-value">‡∂ª‡∑î ${summary.totalOutstanding.toLocaleString()}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>

                <div class="card card-purple">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∂Ö‡∂¥‡∑ö‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂∏‡∑î‡∂Ø‡∂Ω</p>
                            <p class="card-value">‡∂ª‡∑î ${summary.totalExpected.toLocaleString()}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                        </svg>
                    </div>
                </div>

                <div class="card card-yellow">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∂ú‡∑î‡∂ª‡∑î ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏</p>
                            <p class="card-value">‡∂ª‡∑î ${summary.totalIncome.toLocaleString()}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>

                <div class="card card-orange">
                    <div class="card-content">
                        <div>
                            <p class="card-label">‡∑Ñ‡∑í‡∂ü ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä</p>
                            <p class="card-value">${summary.studentsWithOutstanding}</p>
                        </div>
                        <svg class="card-icon" width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            `;
        }

        function getSummary() {
            const allStudents = allStudentsData.length > 0 ? allStudentsData : reportData;
            
            const totalExpected = allStudents.reduce((sum, s) => sum + s.monthly_fee, 0);
            const totalPaid = allStudents.reduce((sum, s) => sum + s.paidAmount, 0);
            const totalOutstanding = allStudents.reduce((sum, s) => sum + s.outstandingAmount, 0);
            const totalIncome = allStudents.reduce((sum, s) => sum + s.treport, 0);
            const studentsWithOutstanding = allStudents.filter(s => s.outstandingAmount > 0).length;

            return {
                totalExpected,
                totalPaid,
                totalOutstanding,
                totalIncome,
                totalStudents: allStudents.length,
                studentsWithOutstanding
            };
        }

        function renderCharts() {
            const barData = reportData.slice(0, 10);
            const barLabels = barData.map(s => s.studentname.length > 12 ? s.studentname.substring(0, 10) + '...' : s.studentname);
            const paidData = barData.map(s => s.paidAmount);
            const outstandingData = barData.map(s => s.outstandingAmount);

            if (barChartInstance) barChartInstance.destroy();
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: barLabels,
                    datasets: [
                        {
                            label: '‡∂ú‡∑ô‡∑Ä‡∑ñ',
                            data: paidData,
                            backgroundColor: '#10b981'
                        },
                        {
                            label: '‡∑Ñ‡∑í‡∂ü',
                            data: outstandingData,
                            backgroundColor: '#ef4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const statusCounts = {
                '‡∂ú‡∑ô‡∑Ä‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä': 0,
                '‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä': 0,
                '‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂ü‡∑Ä‡∑ì‡∂∏': 0
            };

            reportData.forEach(s => {
                statusCounts[s.paymentStatus]++;
            });

            const pieLabels = Object.keys(statusCounts).filter(k => statusCounts[k] > 0);
            const pieData = pieLabels.map(k => statusCounts[k]);
            const pieColors = ['#10b981', '#f59e0b', '#ef4444'];

            if (pieChartInstance) pieChartInstance.destroy();
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChartInstance = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: pieLabels,
                    datasets: [{
                        data: pieData,
                        backgroundColor: pieColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = reportData.map((student, index) => {
                const statusClass = student.paymentStatus === '‡∂ú‡∑ô‡∑Ä‡∑è ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä' 
                    ? 'status-success' 
                    : student.paymentStatus === '‡∂Ö‡∂±‡∂≠‡∑î‡∂ª‡∑î ‡∂á‡∂ü‡∑Ä‡∑ì‡∂∏'
                    ? 'status-danger'
                    : 'status-warning';

                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td class="font-bold">${student.studentname}</td>
                        <td class="text-right">‡∂ª‡∑î ${student.monthly_fee.toLocaleString()}</td>
                        <td class="text-right text-green">‡∂ª‡∑î ${student.paidAmount.toLocaleString()}</td>
                        <td class="text-right text-red">
                            ${student.outstandingAmount > 0 ? `‡∂ª‡∑î ${student.outstandingAmount.toLocaleString()}` : '-'}
                        </td>
                        <td class="text-center">
                            ${student.monthsOutstanding > 0 ? student.monthsOutstanding : '-'}
                        </td>
                        <td class="text-center text-orange">
                            ${student.unpaidDays > 0 ? student.unpaidDays : '-'}
                        </td>
                        <td class="text-center text-blue">${student.totalAttendance}</td>
                        <td class="text-center">
                            <span class="status-badge ${statusClass}">
                                ${student.paymentStatus}
                            </span>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function downloadPDF() {
            window.print();
        }

        function copyReport() {
            if (!reportData || reportData.length === 0) {
                alert('‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂Ø‡∂≠‡∑ä‡∂≠ ‡∂±‡∑ú‡∂∏‡∑ê‡∂≠');
                return;
            }

            const summary = getSummary();
            const selectedMonth = document.getElementById('monthSelect').value;
            const monthName = MONTHS[selectedMonth];
            const currentYear = new Date().getFullYear();

            let text = `üéì *${currentTeacherName} - ‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä*\n`;
            text += `üìÖ *‡∂∏‡∑è‡∑É‡∂∫:* ${monthName} ${currentYear}\n\n`;
            text += `üìä *‡∑É‡∑è‡∂ª‡∑è‡∂Ç‡∑Å‡∂∫:*\n`;
            text += `üë• ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä ‡∑É‡∂Ç‡∂õ‡∑ä‚Äç‡∂∫‡∑è‡∑Ä: ${summary.totalStudents}\n`;
            text += `üí∞ ‡∂Ö‡∂¥‡∑ö‡∂ö‡∑ä‡∑Ç‡∑í‡∂≠ ‡∂∏‡∑î‡∂Ø‡∂Ω: ‡∂ª‡∑î ${summary.totalExpected.toLocaleString()}\n`;
            text += `‚úÖ ‡∂ú‡∑ô‡∑Ä‡∑ñ ‡∂∏‡∑î‡∂Ø‡∂Ω: ‡∂ª‡∑î ${summary.totalPaid.toLocaleString()}\n`;
            text += `‚ö†Ô∏è ‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω: ‡∂ª‡∑î ${summary.totalOutstanding.toLocaleString()}\n`;
            text += `üíµ ‡∂ú‡∑î‡∂ª‡∑î ‡∂Ü‡∂Ø‡∑è‡∂∫‡∂∏: ‡∂ª‡∑î ${summary.totalIncome.toLocaleString()}\n`;
            text += `‚ö° ‡∑Ñ‡∑í‡∂ü ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä: ${summary.studentsWithOutstanding}\n\n`;

            if (summary.studentsWithOutstanding > 0) {
                text += `üö® *‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω‡∑ä ‡∂á‡∂≠‡∑í ‡∑É‡∑í‡∑É‡∑î‡∂±‡∑ä:*\n\n`;
                reportData
                    .filter(s => s.outstandingAmount > 0)
                    .forEach((s, i) => {
                        text += `${i + 1}. *${s.studentname}*\n`;
                        text += `   ‡∂∏‡∑è‡∑É‡∑í‡∂ö ‡∂ú‡∑è‡∑É‡∑ä‡∂≠‡∑î‡∑Ä: ‡∂ª‡∑î ${s.monthly_fee.toLocaleString()}\n`;
                        text += `   ‡∑Ñ‡∑í‡∂ü ‡∂∏‡∑î‡∂Ø‡∂Ω: ‡∂ª‡∑î ${s.outstandingAmount.toLocaleString()} (‡∂∏‡∑è‡∑É ${s.monthsOutstanding})\n`;
                        text += `   ‡∑Ñ‡∑í‡∂ü ‡∂Ø‡∑í‡∂±: ${s.unpaidDays}\n`;
                        text += `   ‡∂≠‡∂≠‡∑ä‡∑Ä‡∂∫: ${s.paymentStatus}\n\n`;
                    });
            }

            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ ‡∑Ä‡∑è‡∂ª‡∑ä‡∂≠‡∑è‡∑Ä ‡∂¥‡∑í‡∂ß‡∂¥‡∂≠‡∑ä ‡∂ö‡∂ª‡∂± ‡∂Ω‡∂Ø‡∑ì!');
            });
        }

        function shareWhatsApp() {
            copyReport();
            setTimeout(() => {
                window.open('https://wa.me/', '_blank');
            }, 500);
        }
    </script>
</body>
</html>
